<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的閱讀課網頁</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Font Awesome 讓網站有更多圖標 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- 設定字型為 Inter，並設定一些基礎樣式 -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
        /* 自定義彈出視窗的樣式 */
        .modal { 
            /* 修正為絕對隱藏 */
            visibility: hidden;
            opacity: 0;
            transition: visibility 0s, opacity 0.3s linear;
        }
        .modal-visible {
            visibility: visible;
            opacity: 1;
        }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); }
        .sidebar { transform: translateX(-100%); }
        .sidebar-visible { transform: translateX(0); }
        @media (min-width: 1024px) {
            .sidebar { transform: translateX(0); }
        }
    </style>
</head>
<body class="antialiased">

    <!-- 網站主要容器 -->
    <div class="container mx-auto p-4 md:p-8">

        <!-- 網站標頭 -->
        <header class="bg-white rounded-3xl shadow-xl p-6 mb-8 text-center border-b-4 border-blue-500">
            <h1 class="text-4xl font-bold text-gray-800">建德迷閱讀</h1>
            <p class="mt-2 text-lg text-gray-600">想要一雙翅膀，飛越千山；想要一艘小舟，橫渡萬水。閱讀，千山萬水在你眼前。</p>
        </header>

        <!-- 主內容區塊 -->
        <main class="flex flex-col lg:flex-row gap-8">
            
            <!-- 左側導覽列 -->
            <aside class="w-full lg:w-1/4 bg-white rounded-3xl shadow-lg p-6 lg:sticky lg:top-8 self-start">
                <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">網站目錄</h3>
                <nav>
                    <ul class="space-y-2">
                        <li>
                            <a href="#materials-section" class="flex items-center text-gray-700 font-medium hover:text-blue-600 transition duration-200">
                                <i class="fa-solid fa-book-open mr-2 text-lg"></i>
                                <span>最新課程與分享</span>
                            </a>
                        </li>
                        <li>
                            <a href="#news-section" class="flex items-center text-gray-700 font-medium hover:text-blue-600 transition duration-200">
                                <i class="fa-solid fa-newspaper mr-2 text-lg"></i>
                                <span>建德閱讀新鮮報</span>
                            </a>
                        </li>
                        <li class="pt-4 border-t mt-4 hidden lg:block">
                            <h3 class="text-lg font-semibold mb-2 text-gray-800">關於老師</h3>
                            <p class="text-gray-600 text-sm">我是你的閱讀老師，很高興能和大家一起進入閱讀的殿堂！</p>
                        </li>
                        <li class="pt-4 border-t mt-4 hidden lg:block">
                            <h3 class="text-lg font-semibold mb-2 text-gray-800">網站小提醒</h3>
                            <ul class="list-disc list-inside text-gray-600 text-sm space-y-1">
                                <li>點擊「上傳課程資料」可以新增內容。</li>
                                <li>所有內容都會即時同步。</li>
                                <li id="user-id-display">你的使用者ID: 載入中...</li>
                            </ul>
                        </li>
                    </ul>
                </nav>
            </aside>

            <!-- 右側內容展示區 -->
            <div class="lg:w-3/4 space-y-8">
                <!-- 內容上傳按鈕 -->
                <div class="flex justify-end">
                    <button id="upload-btn" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-full shadow-lg hover:bg-blue-700 transition duration-300 transform hover:scale-105">
                        <i class="fa-solid fa-cloud-arrow-up mr-2"></i> 上傳課程資料
                    </button>
                </div>

                <!-- 課程資料展示區 -->
                <section id="materials-section" class="bg-white rounded-3xl shadow-lg p-6">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">最新課程與分享</h2>
                    <div id="materials-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- 資料將由 JavaScript 動態載入 -->
                        <p class="text-center text-gray-500 col-span-full" id="loading-materials">載入中...</p>
                    </div>
                </section>

                <!-- 閱讀新鮮報區塊 -->
                <section id="news-section" class="bg-white rounded-3xl shadow-lg p-6">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">建德閱讀新鮮報</h2>
                    <div id="news-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- 資料將由 JavaScript 動態載入 -->
                        <p class="text-center text-gray-500 col-span-full" id="loading-news">載入中...</p>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- 上傳課程資料的彈出視窗 (Modal) -->
    <div id="upload-modal" class="modal fixed inset-0 flex items-center justify-center p-4 z-50">
        <div class="modal-overlay absolute inset-0"></div>
        <div class="modal-container bg-white rounded-3xl shadow-xl z-50 overflow-y-auto w-full max-w-2xl transform transition-all duration-300 ease-out scale-95">
            <div class="modal-content py-4 px-6">
                <!-- 視窗標題和關閉按鈕 -->
                <div class="flex justify-between items-center pb-3">
                    <p class="text-2xl font-bold text-gray-800">上傳新的課程資料</p>
                    <button id="close-modal-btn" class="modal-close cursor-pointer z-50 text-gray-500 hover:text-gray-800 transition-colors duration-200">
                        <i class="fa-solid fa-xmark text-2xl"></i>
                    </button>
                </div>

                <!-- 上傳表單 -->
                <form id="upload-form" class="space-y-4">
                    <div>
                        <label for="material-type" class="block text-gray-700 font-bold mb-2">發布類型</label>
                        <select id="material-type" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                            <option value="reading_materials">最新課程與分享</option>
                            <option value="reading_news">建德閱讀新鮮報</option>
                        </select>
                    </div>
                    <div>
                        <label for="material-title" class="block text-gray-700 font-bold mb-2">標題</label>
                        <input type="text" id="material-title" required class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    </div>
                    <div>
                        <label for="material-content" class="block text-gray-700 font-bold mb-2">內容</label>
                        <textarea id="material-content" rows="4" required class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:outline-none resize-none"></textarea>
                    </div>
                    <div>
                        <label for="material-image" class="block text-gray-700 font-bold mb-2">圖片或影片連結 (非必填)</label>
                        <input type="url" id="material-image" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="輸入圖片、YouTube 或 PDF 連結">
                    </div>
                    <div class="flex justify-end">
                        <button type="submit" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-full shadow-lg hover:bg-blue-700 transition duration-300">
                            <i class="fa-solid fa-paper-plane mr-2"></i> 發布
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 載入 Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, orderBy, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // 確保這些全域變數存在，如果不存在則給予預設值
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // 初始化 Firebase 應用程式
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let userId = null;

        // HTML 元素快取
        const materialsContainer = document.getElementById('materials-container');
        const newsContainer = document.getElementById('news-container');
        const uploadModal = document.getElementById('upload-modal');
        const uploadBtn = document.getElementById('upload-btn');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const uploadForm = document.getElementById('upload-form');
        const loadingMaterialsEl = document.getElementById('loading-materials');
        const loadingNewsEl = document.getElementById('loading-news');
        const userIdDisplayEl = document.getElementById('user-id-display');

        // 登入狀態變更監聽器
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                userIdDisplayEl.textContent = `你的使用者ID: ${userId}`;
                // 登入成功後，開始監聽資料庫
                listenForMaterials();
                listenForNews();
            } else {
                // 如果沒有登入，則匿名登入
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                console.error("登入失敗:", error);
                userIdDisplayEl.textContent = '登入失敗';
                }
            }
        });
        
        // 渲染單一資料卡片
        const renderMaterialCard = (material) => {
            const timestamp = material.timestamp ? new Date(material.timestamp.seconds * 1000) : new Date();
            
            // 判斷是否為 YouTube 影片連結
            const isYouTubeVideo = material.imageUrl && material.imageUrl.includes('youtube.com');
            // 新增判斷是否為 PDF 連結
            const isPdfFile = material.imageUrl && material.imageUrl.toLowerCase().endsWith('.pdf');
            let mediaContent = '';
            
            if (material.imageUrl) {
                if (isYouTubeVideo) {
                    // 提取 YouTube 影片 ID
                    const videoId = material.imageUrl.split('v=')[1];
                    const embedUrl = `https://www.youtube.com/embed/${videoId}`;
                    mediaContent = `
                        <div class="relative pb-9/16 h-0 overflow-hidden rounded-t-lg">
                            <iframe class="absolute inset-0 w-full h-full" src="${embedUrl}" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
                        </div>
                    `;
                } else if (isPdfFile) {
                    // 顯示 PDF 圖示連結
                    mediaContent = `
                        <div class="flex items-center justify-center h-48 bg-red-100 rounded-t-lg text-red-500">
                            <a href="${material.imageUrl}" target="_blank" rel="noopener noreferrer" class="flex flex-col items-center">
                                <i class="fa-solid fa-file-pdf text-6xl"></i>
                                <span class="mt-2 text-sm font-semibold">點此下載 PDF</span>
                            </a>
                        </div>
                    `;
                }
                else {
                    // 預設顯示為圖片
                    mediaContent = `<img src="${material.imageUrl}" alt="${material.title}" class="rounded-t-lg w-full h-48 object-cover">`;
                }
            }

            // 產生每則資料的 HTML 結構
            return `
                <div class="bg-gray-50 rounded-2xl shadow-md overflow-hidden transition-all duration-300 hover:shadow-xl hover:scale-105">
                    ${mediaContent}
                    <div class="p-4">
                        <h4 class="text-xl font-bold text-gray-800 mb-2">${material.title}</h4>
                        <p class="text-gray-600 mb-4">${material.content}</p>
                        <p class="text-xs text-gray-400">發布於: ${timestamp.toLocaleDateString()} ${timestamp.toLocaleTimeString()}</p>
                    </div>
                </div>
            `;
        };

        // 監聽「最新課程與分享」資料庫
        const listenForMaterials = () => {
            const materialsRef = collection(db, `artifacts/${appId}/public/data/reading_materials`);
            const q = query(materialsRef, orderBy('timestamp', 'desc'));

            onSnapshot(q, (snapshot) => {
                let htmlContent = '';
                if (snapshot.empty) {
                    htmlContent = `<p class="text-center text-gray-500 col-span-full">目前沒有任何課程資料。</p>`;
                } else {
                    snapshot.forEach((doc) => {
                        htmlContent += renderMaterialCard(doc.data());
                    });
                }
                materialsContainer.innerHTML = htmlContent;
                loadingMaterialsEl.classList.add('hidden');
            });
        };

        // 監聽「建德閱讀新鮮報」資料庫
        const listenForNews = () => {
            const newsRef = collection(db, `artifacts/${appId}/public/data/reading_news`);
            const q = query(newsRef, orderBy('timestamp', 'desc'));

            onSnapshot(q, (snapshot) => {
                let htmlContent = '';
                if (snapshot.empty) {
                    htmlContent = `<p class="text-center text-gray-500 col-span-full">目前沒有任何新鮮報內容。</p>`;
                } else {
                    snapshot.forEach((doc) => {
                        htmlContent += renderMaterialCard(doc.data());
                    });
                }
                newsContainer.innerHTML = htmlContent;
                loadingNewsEl.classList.add('hidden');
            });
        };

        // 處理上傳表單提交
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const type = document.getElementById('material-type').value;
            const title = document.getElementById('material-title').value;
            const content = document.getElementById('material-content').value;
            const imageUrl = document.getElementById('material-image').value;
            
            // 根據選擇的類型，將資料寫入不同的 Firestore collection
            const collectionName = type;

            try {
                // 將資料新增到 Firestore
                const docRef = await addDoc(collection(db, `artifacts/${appId}/public/data/${collectionName}`), {
                    title,
                    content,
                    imageUrl,
                    timestamp: serverTimestamp(),
                });

                // 成功後清除表單並關閉視窗
                uploadForm.reset();
                uploadModal.classList.remove('modal-visible');
            } catch (error) {
                console.error("發布資料失敗: ", error);
            }
        });

        // 處理彈出視窗的顯示與隱藏
        uploadBtn.addEventListener('click', () => {
            uploadModal.classList.add('modal-visible');
        });

        closeModalBtn.addEventListener('click', () => {
            uploadModal.classList.remove('modal-visible');
        });
        
        // 點擊視窗外也關閉視窗，修正錯誤的id
        uploadModal.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                uploadModal.classList.remove('modal-visible');
            }
        });
    </script>
</body>
</html>
